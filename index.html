<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebXR AR — правильная камера</title>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js",
      "three/examples/jsm/loaders/GLTFLoader": "https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/loaders/GLTFLoader.js"
    }
  }
  </script>
  <style>
    body { margin: 0; overflow: hidden; }
    #start {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 28px;
      font-size: 18px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <button id="start">Войти в AR</button>

  <script type="module">
    document.getElementById('start').addEventListener('click', async () => {
      try {
        const session = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['hit-test']
        });

        const THREE = await import('three');
        const { GLTFLoader } = await import('three/examples/jsm/loaders/GLTFLoader');

        const scene = new THREE.Scene();

        const renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true,
          premultipliedAlpha: false
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Ретикл
        const reticle = new THREE.Mesh(
          new THREE.CylinderGeometry(0.1, 0.1, 0.001, 32),
          new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, transparent: true, opacity: 0.8 })
        );
        reticle.rotation.x = Math.PI / 2;
        reticle.visible = false;
        scene.add(reticle);

        // Debug-куб
        const debugCube = new THREE.Mesh(
          new THREE.BoxGeometry(0.1, 0.1, 0.1),
          new THREE.MeshBasicMaterial({ color: 0xff0000 })
        );
        debugCube.position.set(0, 0, -1);
        scene.add(debugCube);

        // Загрузка модели (опционально)
        const loader = new GLTFLoader();
        loader.load('model.glb', (gltf) => { scene.add(gltf.scene); });

        renderer.xr.setSession(session);

        let hitTestSource = null;
        let refSpace = null;

        session.requestReferenceSpace('local').then(rs => {
          refSpace = rs;
          return session.requestHitTestSource({ space: refSpace });
        }).then(source => {
          hitTestSource = source;
        });

        // ✅ Правильный рендер-цикл с renderer.xr.camera
        renderer.setAnimationLoop((timestamp, frame) => {
          if (!frame) return;

          const xrCamera = renderer.xr.camera;

          if (refSpace && hitTestSource) {
            const results = frame.getHitTestResults(hitTestSource);
            if (results.length > 0) {
              reticle.visible = true;
              reticle.matrix.fromArray(results[0].getPose(refSpace).transform.matrix);
            } else {
              reticle.visible = false;
            }
          }

          renderer.render(scene, xrCamera); // ← критично!
        });

        document.getElementById('start').style.display = 'none';

      } catch (err) {
        alert('Ошибка: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
